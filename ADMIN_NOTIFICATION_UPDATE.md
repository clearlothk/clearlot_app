# 管理員通知系統更新

## 概述

本次更新為管理員儀表板添加了完整的通知系統，包括付款收據接收通知、優惠上傳通知，以及快速審批功能，讓管理員能夠更高效地處理待審批項目。

## 新增功能

### 1. 通知系統

**付款收據通知：**
- 實時監控新的付款收據上傳
- 顯示買家公司、金額、購買ID等關鍵信息
- 支持快速審批和拒絕操作

**優惠上傳通知：**
- 實時監控新的優惠上傳
- 顯示賣家公司、優惠標題、優惠ID等關鍵信息
- 支持快速審批和拒絕操作

**通知計數：**
- 頂部通知鈴鐺顯示未讀通知數量
- 待處理項目面板顯示各類待審批數量
- 實時更新通知狀態

### 2. 快速審批功能

**快速審批模態框：**
- 一鍵審批付款收據和優惠
- 支持拒絕操作，需提供拒絕原因
- 查看詳細信息功能

**審批操作：**
- 批准：自動更新狀態為已批准
- 拒絕：記錄拒絕原因並更新狀態
- 查看詳情：跳轉到相關頁面查看完整信息

### 3. 實時監控

**Firestore 實時監聽：**
- 使用 `onSnapshot` 監聽數據變化
- 自動更新通知列表和計數
- 無需手動刷新頁面

## 技術實現

### 1. 新增服務

**AdminNotificationService：**
```typescript
class AdminNotificationService {
  // 監聽付款收據通知
  listenToPaymentReceipts(callback: (notifications: PaymentReceiptNotification[]) => void)
  
  // 監聽優惠上傳通知
  listenToOfferUploads(callback: (notifications: OfferUploadNotification[]) => void)
  
  // 審批付款收據
  approvePaymentReceipt(purchaseId: string)
  rejectPaymentReceipt(purchaseId: string, reason?: string)
  
  // 審批優惠
  approveOffer(offerId: string)
  rejectOffer(offerId: string, reason?: string)
}
```

**接口定義：**
```typescript
interface PaymentReceiptNotification {
  id: string;
  purchaseId: string;
  buyerId: string;
  buyerCompany: string;
  amount: number;
  timestamp: string;
  status: 'pending' | 'approved' | 'rejected';
  receiptUrl: string;
}

interface OfferUploadNotification {
  id: string;
  offerId: string;
  sellerId: string;
  sellerCompany: string;
  title: string;
  timestamp: string;
  status: 'pending' | 'approved' | 'rejected';
}
```

### 2. 新增組件

**QuickApprovalModal：**
- 統一的快速審批界面
- 支持付款收據和優惠兩種類型
- 包含審批、拒絕、查看詳情三個主要操作

**功能特點：**
- 響應式設計，適配不同屏幕尺寸
- 加載狀態指示
- 錯誤處理和用戶反饋

### 3. 儀表板更新

**通知顯示：**
- 最近活動頂部顯示待審批通知
- 付款收據通知使用藍色主題
- 優惠上傳通知使用綠色主題
- 每個通知包含快速審批按鈕

**狀態管理：**
- 實時更新通知數量
- 自動過濾已處理的通知
- 保持通知列表的最新狀態

## 使用方式

### 1. 查看通知

**通知鈴鐺：**
- 點擊頂部通知鈴鐺查看未讀數量
- 紅色徽章顯示待處理項目總數

**待處理項目面板：**
- 查看付款收據待審批數量
- 查看優惠上傳待審批數量
- 實時更新計數

### 2. 快速審批

**付款收據審批：**
1. 在最近活動中點擊 "Quick Approve" 按鈕
2. 查看付款收據詳情
3. 選擇批准或拒絕
4. 如拒絕需提供原因

**優惠審批：**
1. 在最近活動中點擊 "Quick Approve" 按鈕
2. 查看優惠詳情
3. 選擇批准或拒絕
4. 如拒絕需提供原因

### 3. 查看詳情

**付款收據詳情：**
- 點擊 "View Details" 按鈕
- 在新標籤頁中打開收據圖片
- 查看完整的付款信息

**優惠詳情：**
- 點擊 "View Details" 按鈕
- 跳轉到優惠詳情頁面
- 查看完整的優惠信息

## 數據流程

### 1. 通知觸發

**付款收據上傳：**
1. 買家上傳付款收據
2. Firestore 數據更新
3. 管理員通知服務監聽到變化
4. 儀表板自動更新通知列表

**優惠上傳：**
1. 賣家上傳新優惠
2. Firestore 數據更新
3. 管理員通知服務監聽到變化
4. 儀表板自動更新通知列表

### 2. 審批處理

**批准流程：**
1. 管理員點擊 "Quick Approve"
2. 調用審批服務更新狀態
3. Firestore 數據更新
4. 通知自動從待處理列表移除

**拒絕流程：**
1. 管理員點擊 "Reject"
2. 填寫拒絕原因
3. 調用拒絕服務更新狀態
4. 記錄拒絕原因並更新狀態

## 配置和自定義

### 1. 通知數量限制

**最近活動顯示：**
```typescript
// 付款收據通知最多顯示3個
{paymentReceiptNotifications.filter(n => n.status === 'pending').slice(0, 3).map(...)}

// 優惠上傳通知最多顯示3個
{offerUploadNotifications.filter(n => n.status === 'pending').slice(0, 3).map(...)}
```

**監聽數量限制：**
```typescript
// 付款收據監聽最多20個
limit(20)

// 優惠上傳監聽最多20個
limit(20)
```

### 2. 通知優先級

**付款收據：**
- 高優先級（影響交易流程）
- 藍色主題突出顯示
- 優先顯示在最近活動頂部

**優惠上傳：**
- 中優先級（影響平台內容）
- 綠色主題顯示
- 顯示在付款收據之後

### 3. 審批權限

**管理員權限：**
- 只有已認證的管理員可以審批
- 審批操作記錄在 Firestore 中
- 支持審批和拒絕兩種操作

## 測試建議

### 1. 功能測試

**通知觸發測試：**
1. 上傳新的付款收據
2. 上傳新的優惠
3. 驗證管理員儀表板是否收到通知

**審批功能測試：**
1. 測試付款收據批准
2. 測試付款收據拒絕（含原因）
3. 測試優惠批准
4. 測試優惠拒絕（含原因）

### 2. 實時性測試

**數據同步測試：**
1. 在多個瀏覽器標籤頁中打開管理員儀表板
2. 在一個標籤頁中進行審批操作
3. 驗證其他標籤頁是否自動更新

**通知計數測試：**
1. 檢查未讀通知計數是否準確
2. 驗證待處理項目數量是否實時更新

### 3. 邊界情況測試

**大量通知測試：**
1. 創建大量待審批項目
2. 驗證通知列表性能
3. 檢查內存使用情況

**錯誤處理測試：**
1. 測試網絡中斷情況
2. 測試 Firestore 權限錯誤
3. 驗證錯誤提示和恢復機制

## 性能考慮

### 1. 實時監聽優化

**查詢優化：**
- 使用複合索引優化查詢性能
- 限制監聽數量避免過載
- 使用 `where` 條件過濾無關數據

**內存管理：**
- 及時清理監聽器
- 限制通知列表長度
- 定期清理過期通知

### 2. 用戶體驗優化

**加載狀態：**
- 顯示加載指示器
- 使用骨架屏提升感知性能
- 優雅降級處理錯誤情況

**響應式設計：**
- 適配不同屏幕尺寸
- 優化移動端體驗
- 支持觸控操作

## 未來改進

### 1. 通知管理

**通知歷史：**
- 保存所有通知記錄
- 支持通知搜索和過濾
- 通知歸檔和清理功能

**批量操作：**
- 支持批量審批
- 批量拒絕功能
- 批量導出通知數據

### 2. 審批工作流

**審批流程：**
- 多級審批支持
- 審批委託功能
- 審批時間限制

**審批模板：**
- 預設拒絕原因
- 審批意見模板
- 自動審批規則

### 3. 通知渠道

**多渠道通知：**
- 電子郵件通知
- 推送通知
- 短信通知

**通知偏好：**
- 自定義通知頻率
- 通知類型選擇
- 靜默時間設置

## 總結

本次更新成功為管理員儀表板添加了完整的通知系統和快速審批功能，大幅提升了管理員的工作效率。通過實時監控、快速審批和改進的用戶界面，管理員現在可以：

- ✅ 實時接收付款收據和優惠上傳通知
- ✅ 快速審批待處理項目
- ✅ 查看詳細的項目信息
- ✅ 記錄審批決策和原因
- ✅ 享受流暢的實時更新體驗

這些功能為整個平台的運營管理提供了強有力的支持，確保了交易流程的順暢進行和平台內容的質量控制。 